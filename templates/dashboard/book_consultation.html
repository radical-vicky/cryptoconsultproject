{% extends "base.html" %}
{% load static %}

{% block title %}Book Consultation - Cons-App{% endblock %}

{% block content %}
<section class="py-12" style="background: linear-gradient(135deg, var(--binance-dark), #131722);">
    <div class="container">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">Expert Crypto Consultations</h1>
            <p class="text-xl text-gray-400 max-w-2xl mx-auto">
                Get personalized guidance from our expert analysts. Use your wallet balance or other payment methods.
            </p>
        </div>

        <!-- Wallet Balance Overview -->
        {% if user.is_authenticated %}
        <div class="dashboard-card mb-8">
            <div class="dashboard-card-header">
                <h2 class="dashboard-card-title">Your Wallet Balance</h2>
                <div class="flex items-center gap-4">
                    <span class="text-2xl font-bold text-primary">${{ user_wallet.balance|default:"0.00" }}</span>
                    <a href="{% url 'deposit' %}" class="btn btn-outline">
                        <i class="fas fa-plus"></i> Add Funds
                    </a>
                </div>
            </div>
            <p class="text-gray-400">Available for consultations and analysis purchases</p>
        </div>
        {% endif %}

        <!-- Consultation Packages Grid -->
        <div class="consultation-grid">
            {% for package in consultation_packages %}
            <div class="consultation-card">
                <div class="consultation-level level-{{ package.level }}">{{ package.get_level_display }}</div>
                <div class="consultation-icon icon-{{ package.level }}">
                    <i class="fas fa-{{ package.icon_class|default:'chart-line' }}"></i>
                </div>
                <h3 class="consultation-title">{{ package.title }}</h3>
                <p class="consultation-description">
                    {{ package.description }}
                </p>
                
                <!-- Features List -->
                <ul class="consultation-features">
                    {% for feature in package.features %}
                    <li>{{ feature }}</li>
                    {% empty %}
                    <li>Personalized 1-on-1 session</li>
                    <li>{{ package.duration_minutes }} minutes duration</li>
                    <li>{{ package.get_level_display }} level guidance</li>
                    {% endfor %}
                </ul>
                
                <div class="consultation-price">${{ package.price }}</div>
                <div class="text-center text-gray-400 text-sm mb-4">
                    {{ package.duration_minutes }} minute session
                </div>

                {% if user.is_authenticated %}
                    <!-- Payment Method Selection -->
                    <div class="payment-method-selection mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Payment Method:</label>
                        <div class="space-y-2">
                            <!-- Wallet Payment Option -->
                            <label class="payment-option {% if user_wallet.balance >= package.price %}available{% else %}unavailable{% endif %}">
                                <input type="radio" name="payment_method_{{ package.id }}" value="wallet" 
                                       {% if user_wallet.balance >= package.price %}checked{% else %}disabled{% endif %}>
                                <div class="payment-option-content">
                                    <div class="payment-option-header">
                                        <i class="fas fa-wallet"></i>
                                        <span>Wallet Balance</span>
                                        <span class="payment-balance">${{ user_wallet.balance|default:"0.00" }}</span>
                                    </div>
                                    {% if user_wallet.balance >= package.price %}
                                        <small class="text-success">Sufficient balance</small>
                                    {% else %}
                                        <small class="text-danger">Insufficient balance</small>
                                    {% endif %}
                                </div>
                            </label>

                            <!-- M-Pesa Payment Option -->
                            <label class="payment-option available">
                                <input type="radio" name="payment_method_{{ package.id }}" value="mpesa">
                                <div class="payment-option-content">
                                    <div class="payment-option-header">
                                        <i class="fas fa-mobile-alt"></i>
                                        <span>M-Pesa</span>
                                    </div>
                                    <small>Pay via M-Pesa</small>
                                </div>
                            </label>

                            <!-- PayPal Payment Option -->
                            <label class="payment-option available">
                                <input type="radio" name="payment_method_{{ package.id }}" value="paypal">
                                <div class="payment-option-content">
                                    <div class="payment-option-header">
                                        <i class="fab fa-paypal"></i>
                                        <span>PayPal</span>
                                    </div>
                                    <small>Pay via PayPal</small>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Booking Form -->
                    <form method="post" action="{% url 'book_consultation' %}" class="consultation-booking-form">
                        {% csrf_token %}
                        <input type="hidden" name="package_id" value="{{ package.id }}">
                        <input type="hidden" name="payment_method" id="payment_method_{{ package.id }}" value="wallet">
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-bottom: 0.5rem; font-weight: 500;">
                                <i class="fas fa-calendar-alt"></i> Select Date & Time:
                            </label>
                            <input 
                                type="datetime-local" 
                                name="scheduled_date" 
                                required 
                                min="{% now 'Y-m-d\\TH:i' %}"
                                class="form-input"
                                style="background: var(--binance-dark); border: 1px solid var(--binance-border); color: var(--text-primary);"
                            >
                            <small style="color: var(--text-secondary); font-size: 0.75rem; display: block; margin-top: 0.25rem;">
                                All times are in your local timezone
                            </small>
                        </div>
                        
                        <button 
                            type="submit" 
                            class="btn {% if user_wallet.balance >= package.price %}btn-primary{% else %}btn-outline{% endif %}" 
                            style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600;"
                            id="book_button_{{ package.id }}"
                        >
                            <i class="fas fa-calendar-check"></i>
                            Book {{ package.get_level_display }} Session
                        </button>

                        <!-- Insufficient Balance Help -->
                        {% if user_wallet.balance < package.price %}
                        <div class="mt-3 p-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Need ${{ package.price|floatformat:2 }} but have ${{ user_wallet.balance|floatformat:2 }}
                                </span>
                                <a href="{% url 'deposit' %}" class="text-primary hover:underline">
                                    Add Funds
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </form>
                {% else %}
                    <!-- Guest User CTA -->
                    <div class="space-y-3">
                        <a href="{% url 'account_signup' %}" class="btn btn-primary" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; display: block; text-align: center;">
                            <i class="fas fa-user-plus"></i>
                            Sign Up to Book
                        </a>
                        <a href="{% url 'account_login' %}" class="btn btn-outline" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; display: block; text-align: center;">
                            <i class="fas fa-sign-in-alt"></i>
                            Existing User? Sign In
                        </a>
                    </div>
                {% endif %}
            </div>
            {% empty %}
            <!-- No Packages Available -->
            <div class="consultation-card" style="grid-column: 1 / -1; text-align: center; max-width: 500px; margin: 0 auto;">
                <div class="consultation-icon icon-beginner" style="margin: 0 auto 1rem;">
                    <i class="fas fa-calendar-times"></i>
                </div>
                <h3 class="consultation-title">No Consultation Packages Available</h3>
                <p class="consultation-description">
                    We're currently setting up our consultation services. Please check back soon.
                </p>
                <div class="consultation-price" style="color: var(--text-secondary);">Coming Soon</div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<style>
    .payment-method-selection {
        background: var(--binance-card);
        border: 1px solid var(--binance-border);
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .payment-option {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border: 1px solid var(--binance-border);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .payment-option.available:hover {
        border-color: var(--binance-yellow);
        background: rgba(240, 185, 11, 0.05);
    }

    .payment-option.unavailable {
        opacity: 0.6;
        cursor: not-allowed;
        background: rgba(239, 68, 68, 0.05);
    }

    .payment-option input[type="radio"] {
        margin-right: 0.75rem;
    }

    .payment-option-content {
        flex: 1;
    }

    .payment-option-header {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: 0.25rem;
    }

    .payment-option-header i {
        margin-right: 0.5rem;
        color: var(--binance-yellow);
    }

    .payment-option-header span:first-of-type {
        flex: 1;
        font-weight: 500;
    }

    .payment-balance {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .payment-option small {
        font-size: 0.75rem;
    }

    .text-success {
        color: var(--success-color);
    }

    .text-danger {
        color: var(--danger-color);
    }

    .bg-danger {
        background-color: var(--danger-color);
    }

    .border-danger {
        border-color: var(--danger-color);
    }

    .bg-opacity-10 {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .border-opacity-25 {
        border-color: rgba(0, 0, 0, 0.25);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Payment method selection
        document.querySelectorAll('.payment-option input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const packageId = this.name.split('_')[2];
                const paymentMethod = this.value;
                
                // Update the hidden payment method field
                document.getElementById(`payment_method_${packageId}`).value = paymentMethod;
                
                // Update button text based on payment method
                const bookButton = document.getElementById(`book_button_${packageId}`);
                if (bookButton) {
                    if (paymentMethod === 'wallet') {
                        bookButton.innerHTML = '<i class="fas fa-calendar-check"></i> Book with Wallet';
                        bookButton.className = bookButton.className.replace('btn-outline', 'btn-primary');
                    } else if (paymentMethod === 'mpesa') {
                        bookButton.innerHTML = '<i class="fas fa-mobile-alt"></i> Pay with M-Pesa';
                        bookButton.className = bookButton.className.replace('btn-outline', 'btn-primary');
                    } else if (paymentMethod === 'paypal') {
                        bookButton.innerHTML = '<i class="fab fa-paypal"></i> Pay with PayPal';
                        bookButton.className = bookButton.className.replace('btn-outline', 'btn-primary');
                    }
                }
            });
        });

        // Form submission handling
        document.querySelectorAll('.consultation-booking-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                const dateInput = this.querySelector('input[type="datetime-local"]');
                const paymentMethod = this.querySelector('input[name="payment_method"]').value;
                
                if (dateInput && !dateInput.value) {
                    e.preventDefault();
                    alert('Please select a date and time for your consultation.');
                    dateInput.focus();
                    return;
                }
                
                if (submitBtn) {
                    // Update button text based on payment method
                    if (paymentMethod === 'wallet') {
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing with Wallet...';
                    } else if (paymentMethod === 'mpesa') {
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Redirecting to M-Pesa...';
                    } else if (paymentMethod === 'paypal') {
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Redirecting to PayPal...';
                    }
                    
                    submitBtn.disabled = true;
                }
            });
        });

        // Date validation
        const dateInputs = document.querySelectorAll('input[type="datetime-local"]');
        dateInputs.forEach(input => {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            input.min = localDateTime;
            
            input.addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                const now = new Date();
                
                if (selectedDate < now) {
                    alert('Please select a future date and time for your consultation.');
                    this.value = '';
                }
            });
        });
    });
</script>
{% endblock %}