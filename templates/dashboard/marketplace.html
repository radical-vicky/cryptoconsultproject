{% extends "base.html" %}
{% load static %}

{% block title %}Marketplace - CryptoConsult{% endblock %}

{% block content %}

<style>
/* Binance-style Marketplace */
.marketplace-container {
    max-width: 1400px;
    margin: 80px auto 2rem;
    padding: 0 1rem;
}

/* Header Section */
.marketplace-header {
    margin-bottom: 2rem;
    padding: 1.5rem 0;
    border-bottom: 1px solid #2b3139;
}

.marketplace-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: #f0b90b;
    margin-bottom: 0.25rem;
}

.marketplace-subtitle {
    color: #848e9c;
    font-size: 0.95rem;
}

/* Stats Overview - Binance Style */
.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-item {
    background: #1e2329;
    border: 1px solid #2b3139;
    border-radius: 4px;
    padding: 1.25rem;
    text-align: center;
    transition: all 0.2s ease;
}

.stat-item:hover {
    border-color: #f0b90b;
    background: #1a1f25;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: #eaecef;
    margin-bottom: 0.25rem;
}

.stat-label {
    color: #848e9c;
    font-size: 0.85rem;
    font-weight: 500;
}

.stat-link {
    color: #f0b90b;
    font-size: 0.75rem;
    text-decoration: none;
    margin-top: 0.5rem;
    display: inline-block;
}

.stat-link:hover {
    color: #f0b90b;
    text-decoration: underline;
}

/* Filters Section - Binance Style */
.filters-section {
    background: #1e2329;
    border: 1px solid #2b3139;
    border-radius: 4px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.filters-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
}

.filter-group {
    margin-bottom: 0;
}

.filter-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    color: #848e9c;
    margin-bottom: 0.5rem;
}

.filter-input {
    width: 100%;
    padding: 0.75rem;
    background: #2b3139;
    border: 1px solid #3c4450;
    border-radius: 4px;
    color: #eaecef;
    font-size: 0.85rem;
    transition: all 0.2s ease;
}

.filter-input:focus {
    outline: none;
    border-color: #f0b90b;
    background: #2b3139;
}

.filter-select {
    width: 100%;
    padding: 0.75rem;
    background: #2b3139;
    border: 1px solid #3c4450;
    border-radius: 4px;
    color: #eaecef;
    font-size: 0.85rem;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23848e9c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1em;
}

.filter-select:focus {
    outline: none;
    border-color: #f0b90b;
}

/* Analysis Grid - Binance Card Style */
.analyses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.analysis-card {
    background: #1e2329;
    border: 1px solid #2b3139;
    border-radius: 4px;
    padding: 1.5rem;
    transition: all 0.2s ease;
    position: relative;
}

.analysis-card:hover {
    border-color: #f0b90b;
    background: #1a1f25;
}

.featured-badge {
    position: absolute;
    top: -8px;
    right: 1rem;
    background: #f0b90b;
    color: #000000;
    padding: 0.25rem 0.75rem;
    border-radius: 2px;
    font-size: 0.7rem;
    font-weight: 600;
}

.analysis-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.analysis-crypto {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.analysis-symbol {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    background: #2b3139;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #eaecef;
    font-size: 0.8rem;
}

.analysis-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #eaecef;
    margin: 0;
}

.analysis-price {
    text-align: right;
}

.price-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #f0b90b;
}

.price-label {
    color: #848e9c;
    font-size: 0.7rem;
}

.analysis-description {
    color: #848e9c;
    font-size: 0.8rem;
    line-height: 1.4;
    margin-bottom: 1rem;
}

.analysis-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
}

.detail-icon {
    color: #848e9c;
    font-size: 0.7rem;
}

.detail-text {
    color: #848e9c;
}

.risk-low { color: #03a66d; }
.risk-medium { color: #f0b90b; }
.risk-high { color: #cf304a; }

.analysis-features {
    margin-bottom: 1rem;
}

.features-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: #eaecef;
    margin-bottom: 0.5rem;
}

.features-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.feature-item {
    color: #848e9c;
    font-size: 0.7rem;
    padding: 0.15rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.feature-check {
    color: #03a66d;
    font-size: 0.6rem;
}

.analysis-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.btn {
    padding: 0.6rem 1rem;
    border: none;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-primary {
    background: #f0b90b;
    color: #000000;
}

.btn-primary:hover {
    background: #e0ac0a;
    color: #000000;
    text-decoration: none;
}

.btn-outline {
    background: transparent;
    color: #848e9c;
    border: 1px solid #3c4450;
}

.btn-outline:hover {
    background: #2b3139;
    color: #eaecef;
    text-decoration: none;
}

.btn-disabled {
    background: #2b3139;
    color: #5e6673;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-disabled:hover {
    background: #2b3139;
    color: #5e6673;
}

.analysis-analyst {
    border-top: 1px solid #2b3139;
    padding-top: 1rem;
}

.analyst-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.analyst-avatar {
    width: 28px;
    height: 28px;
    border-radius: 4px;
    background: #2b3139;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: #848e9c;
}

.analyst-details {
    flex: 1;
}

.analyst-name {
    color: #848e9c;
    font-size: 0.75rem;
    font-weight: 500;
}

.analyst-sales {
    color: #5e6673;
    font-size: 0.65rem;
}

/* Section Header */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #2b3139;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #eaecef;
    margin: 0;
}

.section-count {
    color: #848e9c;
    font-size: 0.85rem;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: #848e9c;
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #eaecef;
    margin-bottom: 0.5rem;
}

.empty-state p {
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
}

.pagination-link {
    padding: 0.5rem 1rem;
    background: transparent;
    color: #848e9c;
    border: 1px solid #3c4450;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.85rem;
    transition: all 0.2s ease;
}

.pagination-link:hover {
    background: #2b3139;
    color: #eaecef;
    text-decoration: none;
}

.pagination-info {
    color: #848e9c;
    font-size: 0.85rem;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #1e2329;
    border: 1px solid #2b3139;
    border-radius: 4px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    position: relative;
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #cf304a;
    color: white;
    border: none;
    border-radius: 4px;
    width: 2rem;
    height: 2rem;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #eaecef;
    margin-bottom: 1.5rem;
    text-align: center;
}

/* Processing States */
.processing-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(30, 35, 41, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    z-index: 10;
}

.processing-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(240, 185, 11, 0.3);
    border-radius: 50%;
    border-top-color: #f0b90b;
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 1rem;
}

.processing-text {
    color: #f0b90b;
    font-size: 0.9rem;
    font-weight: 500;
}

.processing-details {
    color: #848e9c;
    font-size: 0.7rem;
    text-align: center;
    margin-top: 0.5rem;
    max-width: 200px;
}

/* Loading States */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(240, 185, 11, 0.3);
    border-radius: 50%;
    border-top-color: #f0b90b;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Error States */
.error-message {
    background: rgba(207, 48, 74, 0.1);
    border: 1px solid rgba(207, 48, 74, 0.3);
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
    color: #cf304a;
    text-align: center;
    font-size: 0.8rem;
}

.success-message {
    background: rgba(3, 166, 109, 0.1);
    border: 1px solid rgba(3, 166, 109, 0.3);
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
    color: #03a66d;
    text-align: center;
    font-size: 0.8rem;
}

.warning-message {
    background: rgba(240, 185, 11, 0.1);
    border: 1px solid rgba(240, 185, 11, 0.3);
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
    color: #f0b90b;
    text-align: center;
    font-size: 0.8rem;
}

/* Purchase Status Styles */
.purchase-status {
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    text-align: center;
}

.status-processing {
    background: rgba(240, 185, 11, 0.1);
    border: 1px solid rgba(240, 185, 11, 0.3);
    color: #f0b90b;
}

.status-success {
    background: rgba(3, 166, 109, 0.1);
    border: 1px solid rgba(3, 166, 109, 0.3);
    color: #03a66d;
}

.status-error {
    background: rgba(207, 48, 74, 0.1);
    border: 1px solid rgba(207, 48, 74, 0.3);
    color: #cf304a;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .filters-grid {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
}

@media (max-width: 768px) {
    .marketplace-container {
        margin: 70px auto 1rem;
        padding: 0 0.5rem;
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }
    
    .analyses-grid {
        grid-template-columns: 1fr;
    }
    
    .analysis-actions {
        grid-template-columns: 1fr;
    }
    
    .stats-overview {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .stats-overview {
        grid-template-columns: 1fr;
    }
    
    .analysis-details {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="marketplace-container">
    <!-- Header Section -->
    <div class="marketplace-header">
        <h1 class="marketplace-title">Crypto Analysis Marketplace</h1>
        <p class="marketplace-subtitle">Premium cryptocurrency analysis reports from expert traders</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
        <div class="stat-item">
            <div class="stat-value">$<span id="walletBalance">{{ user_wallet.balance|default:"0.00" }}</span></div>
            <div class="stat-label">Available Balance</div>
            <a href="{% url 'deposit' %}" class="stat-link">Add Funds</a>
        </div>
        
        <div class="stat-item">
            <div class="stat-value">{{ purchased_count }}</div>
            <div class="stat-label">Total Purchases</div>
            <div class="stat-link">Analyses Bought</div>
        </div>
        
        <div class="stat-item">
            <div class="stat-value">{{ analyses|length }}</div>
            <div class="stat-label">Available Analyses</div>
            <div class="stat-link">Premium Reports</div>
        </div>
        
        <div class="stat-item">
            <div class="stat-value">${{ total_spent|default:"0.00" }}</div>
            <div class="stat-label">Total Spent</div>
            <div class="stat-link">Lifetime Value</div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="filters-section">
        <div class="filters-grid">
            <!-- Search -->
            <div class="filter-group">
                <label class="filter-label">Search Analyses</label>
                <div style="position: relative;">
                    <input type="text" 
                           id="searchInput"
                           placeholder="Search cryptocurrency, analyst..."
                           class="filter-input"
                           style="padding-left: 2.5rem;">
                    <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #848e9c;">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="filter-group">
                <label class="filter-label">Category</label>
                <select class="filter-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="technical">Technical Analysis</option>
                    <option value="fundamental">Fundamental Analysis</option>
                    <option value="trading">Trading Signals</option>
                    <option value="market">Market Research</option>
                </select>
            </div>

            <!-- Risk Level Filter -->
            <div class="filter-group">
                <label class="filter-label">Risk Level</label>
                <select class="filter-select" id="riskFilter">
                    <option value="">All Risk Levels</option>
                    <option value="low">Low Risk</option>
                    <option value="medium">Medium Risk</option>
                    <option value="high">High Risk</option>
                </select>
            </div>

            <!-- Sort By -->
            <div class="filter-group">
                <label class="filter-label">Sort By</label>
                <select class="filter-select" id="sortFilter">
                    <option value="newest">Newest First</option>
                    <option value="price_low">Price: Low to High</option>
                    <option value="price_high">Price: High to Low</option>
                    <option value="rating">Highest Rated</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Analyses Grid -->
    <div>
        <div class="section-header">
            <h2 class="section-title">Premium Crypto Analyses</h2>
            <div class="section-count">Showing <span id="analysesCount">{{ analyses|length }}</span> analyses</div>
        </div>

        {% if analyses %}
        <div class="analyses-grid" id="analysesGrid">
            {% for analysis in analyses %}
            <div class="analysis-card" data-analysis-id="{{ analysis.id }}" 
                 data-category="{{ analysis.analysis_type }}" 
                 data-risk="{{ analysis.risk_level }}"
                 data-price="{{ analysis.price }}"
                 data-rating="{{ analysis.rating }}"
                 data-name="{{ analysis.cryptocurrency|lower }}"
                 data-symbol="{{ analysis.symbol|lower }}"
                 data-analyst="{{ analysis.analyst.analyst_name|lower }}"
                 id="analysis-card-{{ analysis.id }}">
                
                <!-- Processing Overlay -->
                {% if analysis.processing_purchase %}
                <div class="processing-overlay" id="processing-{{ analysis.id }}">
                    <div class="processing-spinner"></div>
                    <div class="processing-text">Processing Purchase...</div>
                    <div class="processing-details">Please wait while we complete your transaction</div>
                </div>
                {% endif %}

                <!-- Featured Badge -->
                {% if analysis.is_featured %}
                <div class="featured-badge">Featured</div>
                {% endif %}

                <!-- Analysis Header -->
                <div class="analysis-header">
                    <div class="analysis-crypto">
                        <div class="analysis-symbol">
                            {{ analysis.symbol }}
                        </div>
                        <div>
                            <h3 class="analysis-name">{{ analysis.cryptocurrency }}</h3>
                        </div>
                    </div>
                    <div class="analysis-price">
                        <div class="price-value">${{ analysis.price }}</div>
                        <div class="price-label">One-time purchase</div>
                    </div>
                </div>

                <!-- Analysis Description -->
                <p class="analysis-description">
                    {{ analysis.description }}
                </p>

                <!-- Analysis Details -->
                <div class="analysis-details">
                    <div class="detail-item">
                        <span class="detail-icon">üìä</span>
                        <span class="detail-text">{{ analysis.get_analysis_type_display }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">‚è±Ô∏è</span>
                        <span class="detail-text">{{ analysis.get_timeframe_display }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">‚ö†Ô∏è</span>
                        <span class="detail-text risk-{{ analysis.risk_level }}">{{ analysis.get_risk_level_display }} Risk</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">‚≠ê</span>
                        <span class="detail-text">{{ analysis.rating }}/5.0</span>
                    </div>
                </div>

                <!-- Key Features -->
                <div class="analysis-features">
                    <h4 class="features-title">What's Included:</h4>
                    <ul class="features-list">
                        {% for feature in analysis.features_list %}
                        <li class="feature-item">
                            <span class="feature-check">‚úì</span>
                            {{ feature }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Action Buttons -->
                <div class="analysis-actions">
                    {% if analysis.is_purchased %}
                    <a href="{% url 'view_analysis' analysis.id %}" class="btn btn-primary">
                        <i class="fas fa-eye"></i>
                        View Analysis
                    </a>
                    {% elif analysis.processing_purchase %}
                    <button class="btn btn-disabled" disabled>
                        <div class="loading" style="width: 16px; height: 16px;"></div>
                        Processing...
                    </button>
                    {% else %}
                    <button onclick="openPurchaseModal('{{ analysis.id }}')" class="btn btn-primary" id="purchase-btn-{{ analysis.id }}">
                        <i class="fas fa-shopping-cart"></i>
                        Purchase
                    </button>
                    {% endif %}
                    
                    <button onclick="openPreviewModal('{{ analysis.id }}')" class="btn btn-outline">
                        <i class="fas fa-search"></i>
                        Preview
                    </button>
                </div>

                <!-- Analyst Info -->
                <div class="analysis-analyst">
                    <div class="analyst-info">
                        <div class="analyst-avatar">
                            {{ analysis.analyst.analyst_initials }}
                        </div>
                        <div class="analyst-details">
                            <div class="analyst-name">{{ analysis.analyst.analyst_name }}</div>
                            <div class="analyst-sales">{{ analysis.sales_count }} sales</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3>No analyses available</h3>
            <p>Check back later for new premium crypto analyses</p>
        </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if analyses.has_other_pages %}
    <div class="pagination">
        {% if analyses.has_previous %}
        <a href="?page={{ analyses.previous_page_number }}" class="pagination-link">
            <i class="fas fa-chevron-left"></i> Previous
        </a>
        {% endif %}

        <div class="pagination-info">
            Page {{ analyses.number }} of {{ analyses.paginator.num_pages }}
        </div>

        {% if analyses.has_next %}
        <a href="?page={{ analyses.next_page_number }}" class="pagination-link">
            Next <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Purchase Modal -->
<div id="purchaseModal" class="modal">
    <div class="modal-content">
        <button onclick="closePurchaseModal()" class="modal-close">
            √ó
        </button>
        
        <h2 class="modal-title">Purchase Analysis</h2>
        
        <div id="purchaseModalContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <button onclick="closePreviewModal()" class="modal-close">
            √ó
        </button>
        
        <h2 class="modal-title">Analysis Preview</h2>
        
        <div id="previewModalContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<script>
// Global variables
let currentAnalysisId = null;
let purchaseInProgress = false;

// Get CSRF Token for AJAX requests
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// Show error message
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
    return errorDiv;
}

// Show success message
function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    return successDiv;
}

// Show warning message
function showWarning(message) {
    const warningDiv = document.createElement('div');
    warningDiv.className = 'warning-message';
    warningDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    return warningDiv;
}

// Show loading state
function showLoading() {
    return `
        <div style="text-align: center; padding: 2rem;">
            <div class="loading" style="margin: 0 auto 1rem;"></div>
            <p style="color: #848e9c;">Loading...</p>
        </div>
    `;
}

// Show processing state for purchase
function showProcessingState(analysisId) {
    const card = document.getElementById(`analysis-card-${analysisId}`);
    const purchaseBtn = document.getElementById(`purchase-btn-${analysisId}`);
    
    if (card && purchaseBtn) {
        // Create processing overlay
        const overlay = document.createElement('div');
        overlay.className = 'processing-overlay';
        overlay.id = `processing-${analysisId}`;
        overlay.innerHTML = `
            <div class="processing-spinner"></div>
            <div class="processing-text">Processing Purchase...</div>
            <div class="processing-details">Please wait while we complete your transaction</div>
        `;
        card.appendChild(overlay);
        
        // Disable purchase button
        purchaseBtn.innerHTML = '<div class="loading" style="width: 16px; height: 16px;"></div> Processing...';
        purchaseBtn.className = 'btn btn-disabled';
        purchaseBtn.disabled = true;
    }
}

// Remove processing state
function removeProcessingState(analysisId) {
    const overlay = document.getElementById(`processing-${analysisId}`);
    const purchaseBtn = document.getElementById(`purchase-btn-${analysisId}`);
    
    if (overlay) {
        overlay.remove();
    }
    
    if (purchaseBtn) {
        purchaseBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Purchase';
        purchaseBtn.className = 'btn btn-primary';
        purchaseBtn.disabled = false;
    }
}

// Update card to purchased state
function updateCardToPurchased(analysisId) {
    const card = document.getElementById(`analysis-card-${analysisId}`);
    const purchaseBtn = document.getElementById(`purchase-btn-${analysisId}`);
    
    if (card && purchaseBtn) {
        // Remove processing overlay
        removeProcessingState(analysisId);
        
        // Update button to view analysis
        purchaseBtn.innerHTML = '<i class="fas fa-eye"></i> View Analysis';
        purchaseBtn.className = 'btn btn-success';
        purchaseBtn.onclick = function() {
            window.location.href = `/view-analysis/${analysisId}/`;
        };
        
        // Update wallet balance display
        updateWalletBalance();
    }
}

// Update wallet balance display
function updateWalletBalance() {
    // Fetch updated balance from server
    fetch('/check-wallet-balance/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const walletBalance = document.getElementById('walletBalance');
            if (walletBalance) {
                walletBalance.textContent = parseFloat(data.balance).toFixed(2);
            }
        }
    })
    .catch(error => {
        console.error('Error updating wallet balance:', error);
    });
}

// Instant purchase function using AJAX
async function instantPurchase(analysisId) {
    if (purchaseInProgress) {
        return;
    }
    
    purchaseInProgress = true;
    currentAnalysisId = analysisId;
    
    // Show processing state
    showProcessingState(analysisId);
    
    try {
        // Create form data
        const formData = new FormData();
        formData.append('analysis_id', analysisId);
        formData.append('csrfmiddlewaretoken', getCSRFToken());
        
        // Send AJAX request
        const response = await fetch('{% url "purchase_analysis" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Purchase successful
            showPurchaseSuccess(analysisId, result);
            updateCardToPurchased(analysisId);
            
            // Update purchased count
            updatePurchasedCount();
            
        } else if (result.status === 'already_purchased') {
            // Already purchased - redirect to view
            window.location.href = result.redirect_url;
            
        } else {
            // Show error
            removeProcessingState(analysisId);
            showPurchaseError(result.message || 'Purchase failed. Please try again.');
        }
        
    } catch (error) {
        console.error('Purchase error:', error);
        removeProcessingState(analysisId);
        showPurchaseError('Network error. Please check your connection and try again.');
    } finally {
        purchaseInProgress = false;
    }
}

// Show purchase success
function showPurchaseSuccess(analysisId, result) {
    // Create success modal
    const successModal = document.createElement('div');
    successModal.className = 'modal';
    successModal.style.display = 'flex';
    successModal.innerHTML = `
        <div class="modal-content">
            <div style="text-align: center; padding: 2rem;">
                <div style="color: #03a66d; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 style="color: #03a66d; margin-bottom: 1rem;">Purchase Successful!</h3>
                <p style="color: #848e9c; margin-bottom: 1.5rem;">
                    You have successfully purchased the analysis. You can now view it immediately.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button onclick="closeSuccessModal(this)" class="btn btn-outline">
                        Continue Shopping
                    </button>
                    <button onclick="viewPurchasedAnalysis('${analysisId}')" class="btn btn-primary">
                        <i class="fas fa-eye"></i> View Analysis
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(successModal);
    document.body.style.overflow = 'hidden';
}

// Close success modal
function closeSuccessModal(button) {
    const modal = button.closest('.modal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
}

// View purchased analysis
function viewPurchasedAnalysis(analysisId) {
    window.location.href = `/view-analysis/${analysisId}/`;
}

// Show purchase error
function showPurchaseError(message) {
    // Create error modal
    const errorModal = document.createElement('div');
    errorModal.className = 'modal';
    errorModal.style.display = 'flex';
    errorModal.innerHTML = `
        <div class="modal-content">
            <div style="text-align: center; padding: 2rem;">
                <div style="color: #cf304a; font-size: 3rem; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 style="color: #cf304a; margin-bottom: 1rem;">Purchase Failed</h3>
                <p style="color: #848e9c; margin-bottom: 1.5rem;">${message}</p>
                <button onclick="closeErrorModal(this)" class="btn btn-primary">
                    Try Again
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(errorModal);
    document.body.style.overflow = 'hidden';
}

// Close error modal
function closeErrorModal(button) {
    const modal = button.closest('.modal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
}

// Update purchased count
function updatePurchasedCount() {
    const purchasedCountElement = document.querySelector('.stat-item:nth-child(2) .stat-value');
    if (purchasedCountElement) {
        const currentCount = parseInt(purchasedCountElement.textContent);
        purchasedCountElement.textContent = currentCount + 1;
    }
}

// Enhanced purchase modal with instant purchase option
async function openPurchaseModal(analysisId) {
    if (purchaseInProgress) {
        return;
    }
    
    const modal = document.getElementById('purchaseModal');
    const content = document.getElementById('purchaseModalContent');
    
    currentAnalysisId = analysisId;
    
    // Show loading state
    content.innerHTML = showLoading();
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    try {
        // Get analysis data from the current page
        const analysisCard = document.querySelector(`[data-analysis-id="${analysisId}"]`);
        if (!analysisCard) {
            throw new Error('Analysis not found');
        }
        
        const analysisName = analysisCard.querySelector('.analysis-name').textContent;
        const analysisSymbol = analysisCard.querySelector('.analysis-symbol').textContent;
        const analysisPrice = analysisCard.querySelector('.price-value').textContent.replace('$', '');
        const analysisDescription = analysisCard.querySelector('.analysis-description').textContent;
        const userBalance = parseFloat('{{ user_wallet.balance|default:0 }}');
        
        // Check if already purchased
        const isPurchased = analysisCard.querySelector('.btn-primary').textContent.includes('View Analysis');
        
        if (isPurchased) {
            content.innerHTML = `
                <div style="text-align: center;">
                    ${showSuccess('You already own this analysis!').outerHTML}
                    <a href="{% url 'view_analysis' 0 %}".replace('0', analysisId) class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        <i class="fas fa-eye"></i> View Analysis
                    </a>
                </div>
            `;
            return;
        }
        
        // Show purchase options
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 60px; height: 60px; border-radius: 4px; background: #2b3139; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-weight: bold; color: #eaecef; font-size: 1rem;">
                    ${analysisSymbol}
                </div>
                <h3 style="color: #eaecef; font-size: 1.1rem; margin-bottom: 0.5rem;">${analysisName}</h3>
                <p style="color: #848e9c; font-size: 0.8rem;">${analysisDescription}</p>
            </div>
            
            <div style="background: #2b3139; border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: #848e9c;">Price:</span>
                    <span style="color: #f0b90b; font-weight: 600; font-size: 1.1rem;">$${analysisPrice}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #848e9c;">Your Balance:</span>
                    <span style="color: ${userBalance >= analysisPrice ? '#03a66d' : '#cf304a'}; font-weight: 600;">$${userBalance.toFixed(2)}</span>
                </div>
            </div>
            
            ${userBalance >= analysisPrice ? `
                <div style="display: grid; gap: 1rem;">
                    <button onclick="instantPurchase('${analysisId}')" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-bolt"></i> Instant Purchase - $${analysisPrice}
                    </button>
                    <form method="POST" action="{% url 'purchase_analysis' %}" id="purchaseForm">
                        <input type="hidden" name="analysis_id" value="${analysisId}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCSRFToken()}">
                        <button type="submit" class="btn btn-outline" style="width: 100%;" onclick="handleFormPurchase(this, '${analysisId}')">
                            <i class="fas fa-shopping-cart"></i> Traditional Purchase
                        </button>
                    </form>
                </div>
                <p style="color: #848e9c; font-size: 0.7rem; text-align: center; margin-top: 1rem;">
                    Instant purchase uses AJAX for faster processing without page reload
                </p>
            ` : `
                ${showError('Insufficient balance').outerHTML}
                <a href="{% url 'deposit' %}" class="btn" style="width: 100%; background: #03a66d; color: white; text-decoration: none;">
                    <i class="fas fa-wallet"></i> Add Funds to Wallet
                </a>
            `}
            
            <div style="text-align: center; margin-top: 1rem;">
                <a href="#" onclick="closePurchaseModal(); openPreviewModal('${analysisId}');" 
                   style="color: #848e9c; text-decoration: none; font-size: 0.8rem;">
                    <i class="fas fa-search"></i> Preview analysis first
                </a>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading purchase modal:', error);
        content.innerHTML = `
            <div style="text-align: center;">
                ${showError('Failed to load analysis details').outerHTML}
                <button onclick="closePurchaseModal()" class="btn btn-outline" style="margin-top: 1rem;">
                    Close
                </button>
            </div>
        `;
    }
}

// Handle form-based purchase
function handleFormPurchase(button, analysisId) {
    if (purchaseInProgress) {
        return false;
    }
    
    purchaseInProgress = true;
    
    const originalText = button.innerHTML;
    button.innerHTML = '<div class="loading" style="width: 16px; height: 16px;"></div> Processing...';
    button.disabled = true;
    
    // Show processing state on the card
    showProcessingState(analysisId);
    
    // Close modal
    closePurchaseModal();
    
    // Form will submit normally and redirect to purchase_analysis view
    // Let Django handle the purchase logic and redirect
    return true;
}

function closePurchaseModal() {
    const modal = document.getElementById('purchaseModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
    currentAnalysisId = null;
}

async function openPreviewModal(analysisId) {
    const modal = document.getElementById('previewModal');
    const content = document.getElementById('previewModalContent');
    
    // Show loading state
    content.innerHTML = showLoading();
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    try {
        // Get analysis data from the current page
        const analysisCard = document.querySelector(`[data-analysis-id="${analysisId}"]`);
        if (!analysisCard) {
            throw new Error('Analysis not found');
        }
        
        const analysisName = analysisCard.querySelector('.analysis-name').textContent;
        const analysisSymbol = analysisCard.querySelector('.analysis-symbol').textContent;
        const analysisPrice = analysisCard.querySelector('.price-value').textContent.replace('$', '');
        const analysisDescription = analysisCard.querySelector('.analysis-description').textContent;
        
        // Get features list
        const features = [];
        const featureItems = analysisCard.querySelectorAll('.feature-item');
        featureItems.forEach(item => {
            features.push(item.textContent.trim());
        });
        
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 50px; height: 50px; border-radius: 4px; background: #2b3139; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-weight: bold; color: #eaecef;">
                    ${analysisSymbol}
                </div>
                <h3 style="color: #eaecef; font-size: 1.1rem; margin-bottom: 0.5rem;">${analysisName} Analysis Preview</h3>
            </div>
            
            <div style="background: #2b3139; border-radius: 4px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="color: #eaecef; font-size: 0.9rem; margin-bottom: 1rem;">Analysis Overview</h4>
                <p style="color: #848e9c; font-size: 0.8rem; line-height: 1.4; margin-bottom: 1rem;">
                    ${analysisDescription}
                </p>
                
                <h4 style="color: #eaecef; font-size: 0.9rem; margin-bottom: 0.5rem;">What's Included:</h4>
                <ul style="color: #848e9c; font-size: 0.7rem; line-height: 1.4; padding-left: 1rem; margin: 0;">
                    ${features.slice(0, 3).map(feature => `<li>${feature}</li>`).join('')}
                </ul>
                
                <div style="border-top: 1px solid #3c4450; padding-top: 1rem; margin-top: 1rem;">
                    <p style="color: #5e6673; font-size: 0.7rem; text-align: center;">
                        Full analysis includes detailed charts, specific price targets, risk management strategies, and real-time updates.
                    </p>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button onclick="closePreviewModal(); openPurchaseModal('${analysisId}');" class="btn btn-primary">
                    <i class="fas fa-shopping-cart"></i> Purchase - $${analysisPrice}
                </button>
                <button onclick="closePreviewModal()" class="btn btn-outline">
                    Close Preview
                </button>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading preview:', error);
        content.innerHTML = `
            <div style="text-align: center;">
                ${showError('Failed to load preview').outerHTML}
                <button onclick="closePreviewModal()" class="btn btn-outline" style="margin-top: 1rem;">
                    Close
                </button>
            </div>
        `;
    }
}

function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
}

// Search and Filter Functionality
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const riskFilter = document.getElementById('riskFilter').value;
    const sortFilter = document.getElementById('sortFilter').value;
    
    const analysisCards = document.querySelectorAll('.analysis-card');
    let visibleCount = 0;
    
    analysisCards.forEach(card => {
        const analysisName = card.getAttribute('data-name');
        const analysisSymbol = card.getAttribute('data-symbol');
        const analystName = card.getAttribute('data-analyst');
        const category = card.getAttribute('data-category');
        const risk = card.getAttribute('data-risk');
        const price = parseFloat(card.getAttribute('data-price'));
        const rating = parseFloat(card.getAttribute('data-rating'));
        
        const matchesSearch = !searchTerm || 
                            analysisName.includes(searchTerm) || 
                            analysisSymbol.includes(searchTerm) ||
                            analystName.includes(searchTerm);
        
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesRisk = !riskFilter || risk === riskFilter;
        
        const isVisible = matchesSearch && matchesCategory && matchesRisk;
        card.style.display = isVisible ? 'block' : 'none';
        
        if (isVisible) {
            visibleCount++;
        }
    });
    
    // Update visible count
    document.getElementById('analysesCount').textContent = visibleCount;
    
    // Apply sorting
    if (sortFilter !== 'newest') {
        sortAnalyses(sortFilter);
    }
}

function sortAnalyses(sortBy) {
    const grid = document.getElementById('analysesGrid');
    const cards = Array.from(grid.querySelectorAll('.analysis-card[style*="display: block"]'));
    
    cards.sort((a, b) => {
        switch (sortBy) {
            case 'price_low':
                return parseFloat(a.getAttribute('data-price')) - parseFloat(b.getAttribute('data-price'));
            case 'price_high':
                return parseFloat(b.getAttribute('data-price')) - parseFloat(a.getAttribute('data-price'));
            case 'rating':
                return parseFloat(b.getAttribute('data-rating')) - parseFloat(a.getAttribute('data-rating'));
            default:
                return 0;
        }
    });
    
    // Reappend cards in sorted order
    cards.forEach(card => grid.appendChild(card));
}

// Close modals when clicking outside
document.getElementById('purchaseModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePurchaseModal();
    }
});

document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePreviewModal();
    }
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePurchaseModal();
        closePreviewModal();
    }
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Marketplace initialized');
    
    // Add search and filter functionality
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const riskFilter = document.getElementById('riskFilter');
    const sortFilter = document.getElementById('sortFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', performSearch);
    }
    if (categoryFilter) {
        categoryFilter.addEventListener('change', performSearch);
    }
    if (riskFilter) {
        riskFilter.addEventListener('change', performSearch);
    }
    if (sortFilter) {
        sortFilter.addEventListener('change', performSearch);
    }
    
    // Check for any processing states on page load
    const processingCards = document.querySelectorAll('.processing-overlay');
    if (processingCards.length > 0) {
        console.log('Found processing purchases:', processingCards.length);
    }
});
</script>
{% endblock %}